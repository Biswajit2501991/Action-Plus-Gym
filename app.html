<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Action Plus Gym Management</title>
  <link rel="stylesheet" href="style.css">
  <!-- Include jsPDF for generating PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="app-page">
  <!-- Top header bar -->
  <header class="header-bar">
    <div class="admin-icon" onclick="toggleSidebar()">‚ò∞</div>
    <div class="search-container">
      <input type="text" id="searchBar" placeholder="Search members..." oninput="performSearch()">
      <span class="search-icon">üîç</span>
    </div>
    <div class="header-icons">
      <button id="mobileToggle" title="Toggle mobile view" onclick="toggleMobileView()">üì±</button>
      <button id="logoutButton" title="Logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="app-container">
    <!-- Sidebar navigation -->
    <aside id="sidebar" class="sidebar">
      <nav>
        <ul>
          <li onclick="showSection('dashboard')">Dashboard</li>
          <li onclick="showSection('members')">Add/Update Members</li>
          <li onclick="showSection('sms')">WhatsApp SMS</li>
          <li onclick="showSection('finance')">Finance</li>
          <li onclick="showSection('staff')">Staff</li>
          <li onclick="showSection('settings')">Settings</li>
          <li onclick="showSection('logs')">Admin Logs</li>
        </ul>
      </nav>
    </aside>

    <!-- Main content area -->
    <main id="mainContent" class="main-content">
      <!-- Dashboard Section -->
      <section id="dashboardSection" class="section">
        <h2>Dashboard</h2>
        <!-- Container holding all status tables. Each table is rendered dynamically based on member status. -->
        <div id="dashboardStatuses" class="status-grid">
          <!-- Active members table -->
          <div class="status-card" id="activeCard">
            <h3 id="activeHeader">Active (0)</h3>
            <div class="table-container">
              <table id="activeTable">
                <thead>
                  <tr>
                    <!-- Dashboard table columns: ID, Name, Plan, Mobile, Amount, Join Date, Billing Date, Payment By, Status and Actions.  -->
                    <th data-key="id" class="sortable">ID</th>
                    <th data-key="name" class="sortable">Name</th>
                    <th data-key="plan" class="sortable">Plan</th>
                    <th data-key="mobile" class="sortable">Mobile</th>
                    <th data-key="amount" class="sortable">Amount</th>
                    <th data-key="joinDate" class="sortable">Join Date</th>
                    <th data-key="billingDate" class="sortable">Billing Date</th>
                    <th data-key="paymentBy" class="sortable">Payment By</th>
                    <th data-key="status" class="sortable">Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="activeBody"></tbody>
              </table>
            </div>
            <div id="activePagination" class="pagination"></div>
          </div>
          <!-- Hold members table -->
          <div class="status-card" id="holdCard">
            <h3 id="holdHeader">Hold (0)</h3>
            <div class="table-container">
              <table id="holdTable">
                <thead>
                  <tr>
                    <th data-key="id" class="sortable">ID</th>
                    <th data-key="name" class="sortable">Name</th>
                    <th data-key="plan" class="sortable">Plan</th>
                    <th data-key="mobile" class="sortable">Mobile</th>
                    <th data-key="amount" class="sortable">Amount</th>
                    <th data-key="joinDate" class="sortable">Join Date</th>
                    <th data-key="billingDate" class="sortable">Billing Date</th>
                    <th data-key="paymentBy" class="sortable">Payment By</th>
                    <th data-key="status" class="sortable">Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="holdBody"></tbody>
              </table>
            </div>
            <div id="holdPagination" class="pagination"></div>
          </div>
          <!-- Cancelled members table -->
          <div class="status-card" id="cancelledCard">
            <h3 id="cancelledHeader">Cancelled (0)</h3>
            <div class="table-container">
              <table id="cancelledTable">
                <thead>
                  <tr>
                    <th data-key="id" class="sortable">ID</th>
                    <th data-key="name" class="sortable">Name</th>
                    <th data-key="plan" class="sortable">Plan</th>
                    <th data-key="mobile" class="sortable">Mobile</th>
                    <th data-key="amount" class="sortable">Amount</th>
                    <th data-key="joinDate" class="sortable">Join Date</th>
                    <th data-key="billingDate" class="sortable">Billing Date</th>
                    <th data-key="paymentBy" class="sortable">Payment By</th>
                    <th data-key="status" class="sortable">Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="cancelledBody"></tbody>
              </table>
            </div>
            <div id="cancelledPagination" class="pagination"></div>
          </div>
          <!-- Deactivated members table -->
          <div class="status-card" id="deactivatedCard">
            <h3 id="deactivatedHeader">Deactivated (0)</h3>
            <div class="table-container">
              <table id="deactivatedTable">
                <thead>
                  <tr>
                    <th data-key="id" class="sortable">ID</th>
                    <th data-key="name" class="sortable">Name</th>
                    <th data-key="plan" class="sortable">Plan</th>
                    <th data-key="mobile" class="sortable">Mobile</th>
                    <th data-key="amount" class="sortable">Amount</th>
                    <th data-key="joinDate" class="sortable">Join Date</th>
                    <th data-key="billingDate" class="sortable">Billing Date</th>
                    <th data-key="paymentBy" class="sortable">Payment By</th>
                    <th data-key="status" class="sortable">Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="deactivatedBody"></tbody>
              </table>
            </div>
            <div id="deactivatedPagination" class="pagination"></div>
          </div>
        </div>
      </section>

      <!-- Add/Update Members Section -->
      <section id="membersSection" class="section">
        <h2>Add/Update Members <span class="close-icon" onclick="handleClosePage()">&times;</span></h2>
        <form id="memberForm" onsubmit="event.preventDefault(); saveMember();">
          <!-- Personal Information -->
          <div class="form-box">
            <h3>Personal Information
              <button type="button" class="clear-section-btn" title="Clear personal information" onclick="clearPersonalInfo()">Clear</button>
            </h3>
            <table class="member-table">
              <tr>
                <th><label for="mName">Name*</label></th>
                <td><input type="text" id="mName" required></td>
              </tr>
              <tr>
                <th><label for="mDob">Date of Birth*</label></th>
                <td><input type="date" id="mDob" placeholder="dd/mm/yyyy" required></td>
              </tr>
              <tr>
                <th><label for="mGender">Gender*</label></th>
                <td>
                  <select id="mGender" required>
                    <option value="">Select</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th><label for="mMobile">Mobile Number (WhatsApp)*</label></th>
                <td><input type="text" id="mMobile" placeholder="Enter 10 digit number" required></td>
              </tr>
              <tr>
                <th><label for="mPhoto">Upload Photo</label></th>
                <td>
                  <input type="file" id="mPhoto" accept="image/*" onchange="previewMemberPhoto(event)">
                  <div class="photo-preview" onclick="document.getElementById('mPhoto').click()">
                    <img id="mPhotoPreview" alt="Preview" style="display:none;">
                    <span id="mPhotoPlaceholder">Click to upload photo</span>
                  </div>
                </td>
              </tr>
              <tr>
                <th><label for="mEmail">Gmail ID</label></th>
                <td><input type="email" id="mEmail"></td>
              </tr>
              <tr>
                <th><label for="mAddress">Address</label></th>
                <td><textarea id="mAddress"></textarea></td>
              </tr>
            </table>
          </div>
          <!-- Management Information -->
          <div class="form-box">
            <h3>Management Information
              <button type="button" class="clear-section-btn" title="Clear management information" onclick="clearManagementInfo()">Clear</button>
            </h3>
            <table class="member-table">
              <tr>
                <th><label for="mFormNumber">Form Number</label></th>
                <td><input type="text" id="mFormNumber"></td>
              </tr>
              <tr>
                <th><label>ID (Auto)</label></th>
                <td><input type="text" id="mId" readonly></td>
              </tr>
              <tr>
                <th><label for="mStaff">Staff Name</label></th>
                <td><input type="text" id="mStaff" readonly></td>
              </tr>
              <tr>
                <th><label for="mAmount">Membership Amount*</label></th>
                <!-- Only positive integers are allowed; step=1 prevents decimals -->
                <td><input type="number" id="mAmount" min="1" step="1" required></td>
              </tr>
              <tr>
                <th><label for="mPlan">Membership Plan*</label></th>
                <td>
                  <select id="mPlan" required>
                    <option value="">Select Plan</option>
                    <option value="Basic Plan">Basic Plan</option>
                    <option value="Basic-Weekly-Plan">Basic-Weekly-Plan</option>
                    <option value="Personal Trainer (PT) - RAJA">PT - RAJA</option>
                    <option value="Yoga">Yoga</option>
                    <option value="1 Week PT">1 Week PT</option>
                    <option value="2 Week PT">2 Week PT</option>
                    <option value="3 Months Basic">3 Months Basic</option>
                    <option value="6 Months Basic">6 Months Basic</option>
                    <option value="PT - Kaushik">PT - Kaushik</option>
                    <option value="PT - Biswajit">PT - Biswajit</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th><label for="mJoin">Joining Date*</label></th>
                <td><input type="date" id="mJoin" required></td>
              </tr>
              <tr>
                <th><label for="mBill">Billing Date*</label></th>
                <td><input type="date" id="mBill" required></td>
              </tr>
              <tr>
                <th><label for="mStatus">Status*</label></th>
                <td>
                  <select id="mStatus" onchange="toggleHoldField()" required>
                    <option value="Active">Active</option>
                    <option value="Hold">Hold</option>
                    <option value="Deactivated">Deactivated</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th><label for="mHold">Hold Duration</label></th>
                <td>
                  <select id="mHold" disabled>
                    <option value="">Select duration</option>
                    <option value="1 Month">1 Month</option>
                    <option value="2 Months">2 Months</option>
                    <option value="3 Months">3 Months</option>
                    <option value="4 Months">4 Months</option>
                    <option value="5 Months">5 Months</option>
                    <option value="6 Months">6 Months</option>
                    <option value="Rejoining 6-12 months">Rejoining 6-12 months</option>
                    <option value="Readmission after 1 year">Readmission after 1 year</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th><label for="mPaymentMethod">Payment Method*</label></th>
                <td>
                  <select id="mPaymentMethod" required>
                    <option value="">Select method</option>
                    <option value="Cash">Cash</option>
                    <option value="Google Pay">Google Pay</option>
                    <option value="PhonePe">PhonePe</option>
                    <option value="Cash+Online">Cash+Online</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th><label for="mPayMonth">Payment Month</label></th>
                <td><select id="mPayMonth"></select></td>
              </tr>
              <tr>
                <th><label for="mPaymentBy">Payment By</label></th>
                <td><input type="date" id="mPaymentBy" readonly></td>
              </tr>
            </table>
          </div>
          <!-- Other Information -->
          <div class="form-box">
            <h3>Other Information</h3>
            <table class="member-table">
              <tr>
                <th><label for="mRemark">Remark*</label></th>
                <td><textarea id="mRemark" required></textarea></td>
              </tr>
              <tr>
                <td colspan="2">
                  <div class="button-row">
                    <!-- Set flag to indicate saving as a new member. This
                         allows saving a copy when editing an existing record. -->
                    <button type="submit" onclick="saveAsNew = true;">Save</button>
                    <button type="button" onclick="updateMember()">Update</button>
                    <button type="button" onclick="clearMemberForm()">Clear</button>
                    <button type="button" onclick="showOverview()">Next</button>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </form>
        <!-- Member Overview -->
        <div id="overviewSection" style="display:none;">
          <h3>Member Overview</h3>
          <div id="overviewContent"></div>
          <button onclick="hideOverview()">Back to Edit</button>
        </div>
      </section>

      <!-- WhatsApp SMS Section -->
      <section id="smsSection" class="section" style="display:none;">
        <h2>WhatsApp SMS <span class="close-icon" onclick="handleClosePage()">&times;</span></h2>
        <p>Coming soon: Send success, reminder, hold or deactivation messages based on date range.</p>
      </section>

      <!-- Finance Section -->
      <section id="financeSection" class="section" style="display:none;">
        <h2>Finance <span class="close-icon" onclick="handleClosePage()">&times;</span></h2>
        <!-- Date range filters -->
        <div id="financeFilters" class="finance-filters" style="margin-bottom:1rem;">
          <label>From:
            <input type="date" id="finFrom" onchange="renderFinance()">
          </label>
          <label style="margin-left:0.5rem;">To:
            <input type="date" id="finTo" onchange="renderFinance()">
          </label>
        </div>
        <!-- Summary table for payment methods -->
        <div class="table-container">
          <table id="financeTable">
            <thead class="colored">
              <tr>
                <th>Payment Method</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody id="financeBody"></tbody>
            <tfoot id="financeFoot"></tfoot>
          </table>
        </div>
        <p id="financeEmpty" style="display:none; margin-top:1rem;">No payments in this range.</p>
      </section>

      <!-- Staff Section -->
      <section id="staffSection" class="section" style="display:none;">
        <h2>Staff Management <span class="close-icon" onclick="handleClosePage()">&times;</span></h2>
        <!-- Button to add a new user -->
        <button type="button" id="addUserBtn" onclick="showUserForm(null)" class="primary-btn">Add User</button>
        <!-- Container for the staff users table -->
        <div class="table-container">
          <table id="staffTable">
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Staff rows will be injected here -->
            </tbody>
          </table>
        </div>
        <!-- User form for adding/editing users -->
        <div id="userFormContainer" class="modal" style="display:none;">
          <div class="modal-content">
            <span class="close" onclick="hideUserForm()">&times;</span>
            <h3 id="userFormTitle">Add User</h3>
            <form id="userForm" onsubmit="event.preventDefault(); saveUser();">
              <table class="form-table">
                <tr>
                  <th><label for="uUsername">Username*</label></th>
                  <td><input type="text" id="uUsername" required></td>
                </tr>
                <tr>
                  <th><label for="uPassword">Password*</label></th>
                  <td>
                    <input type="password" id="uPassword" placeholder="Leave blank to keep unchanged on edit">
                  </td>
                </tr>
                <tr>
                  <th><label for="uConfirm">Confirm Password*</label></th>
                  <td><input type="password" id="uConfirm" placeholder="Repeat password"></td>
                </tr>
                <tr>
                  <th><label for="uRole">Role*</label></th>
                  <td>
                    <select id="uRole" required onchange="renderPermissionToggles()">
                      <option value="">Select role</option>
                      <option value="admin">Admin</option>
                      <option value="staff-basic">Staff Basic</option>
                      <option value="staff-extended">Staff Extended</option>
                    </select>
                  </td>
                </tr>
              </table>
              <div id="permissionToggles" class="permission-toggles"></div>
              <div class="button-row" style="margin-top:1rem;">
                <button type="submit">Save</button>
                <button type="button" onclick="hideUserForm()">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Settings Section -->
      <section id="settingsSection" class="section" style="display:none;">
        <h2>Settings <span class="close-icon" onclick="handleClosePage()">&times;</span></h2>
        <!-- Settings container will be populated dynamically via app.js -->
        <div id="settingsContainer" class="settings-container"></div>
      </section>

      <!-- Admin Logs Section -->
      <section id="logsSection" class="section" style="display:none;">
        <h2>Admin Logs <span class="close-icon" onclick="handleClosePage()">&times;</span></h2>
        <!-- Logs toolbar: date filters, actor/action filters, search and export -->
        <div id="logsToolbar" class="logs-toolbar">
          <input type="date" id="logFrom" onchange="setLogsFilter()">
          <input type="date" id="logTo" onchange="setLogsFilter()">
          <select id="logActor" onchange="setLogsFilter()">
            <!-- Actor options populated dynamically -->
          </select>
          <select id="logAction" onchange="setLogsFilter()">
            <!-- Action options populated dynamically -->
          </select>
          <input type="text" id="logSearch" placeholder="Search logs..." oninput="debouncedSetLogsFilter()">
          <button type="button" onclick="exportLogsCsv()">Export CSV</button>
        </div>
        <div class="table-container">
          <table id="logsTable">
            <thead class="colored">
              <tr>
                <th>Time</th>
                <th>Actor</th>
                <th>Action</th>
                <th>Target</th>
                <th>Summary</th>
                <th>View</th>
              </tr>
            </thead>
            <tbody id="logsBody"></tbody>
          </table>
        </div>
        <div id="logsPagination" class="pagination"></div>
        <!-- Log detail modal -->
        <div id="logDetailModal" class="modal" style="display:none;">
          <div class="modal-content" style="max-width:600px;">
            <span class="close" onclick="hideLogDetail()">&times;</span>
            <h3>Log Details</h3>
            <div id="logDetailContent"></div>
          </div>
        </div>
        <p id="logsEmpty" style="display:none; margin-top:1rem;">No activity in this range.</p>
      </section>
    </main>
  </div>

  <script src="app.js"></script>
</body>
</html>